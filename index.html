<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Comunidad Davar - Red Ministerial</title>
  
  <!-- Identidad Visual -->
  <link rel="icon" type="image/jpg" href="https://scontent.fsyq4-1.fna.fbcdn.net/v/t39.30808-6/641550060_26884659304454362_7081351474910011629_n.jpg?stp=dst-jpg_p526x296_tt6&_nc_cat=111&ccb=1-7&_nc_sid=13d280&_nc_ohc=2LBns0CevfsQ7kNvwGlaNgn&_nc_oc=AdnqNvceRNeNnJ7J7q5yw0i7Ow-UQZmlazarAScWYjEkBWbR_T2vA4svJ-IEGcvRnSJzVKGqgr75IiSxmhCIcgqe&_nc_zt=23&_nc_ht=scontent.fsyq4-1.fna&_nc_gid=Pxa5MTpWa5LZyLPx7a5hAw&oh=00_AfuuOZe5aSrlizfZJTik_IantMTGcmfCdmixhR_TnwI0-g&oe=69A2BC7D">
  <link rel="apple-touch-icon" href="https://scontent.fsyq4-1.fna.fbcdn.net/v/t39.30808-6/641550060_26884659304454362_7081351474910011629_n.jpg?stp=dst-jpg_p526x296_tt6&_nc_cat=111&ccb=1-7&_nc_sid=13d280&_nc_ohc=2LBns0CevfsQ7kNvwGlaNgn&_nc_oc=AdnqNvceRNeNnJ7J7q5yw0i7Ow-UQZmlazarAScWYjEkBWbR_T2vA4svJ-IEGcvRnSJzVKGqgr75IiSxmhCIcgqe&_nc_zt=23&_nc_ht=scontent.fsyq4-1.fna&_nc_gid=Pxa5MTpWa5LZyLPx7a5hAw&oh=00_AfuuOZe5aSrlizfZJTik_IantMTGcmfCdmixhR_TnwI0-g&oe=69A2BC7D">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Scripts de Poder -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase v10 -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

  <style>
    body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #0f0f0f; margin: 0; color: #e4e6eb; overflow: hidden; height: 100vh; }
    .card-fb { background: #242526; border-radius: 12px; border: 1px solid #3e4042; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b4d4e; border-radius: 10px; }
    .nav-active { background-color: rgba(212, 175, 55, 0.15); color: #D4AF37; font-weight: 900; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    .full-live-container { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; overflow: hidden; }
    .live-controls { position: absolute; top: 40px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 1010; }
    .btn-circle { width: 48px; height: 48px; border-radius: 50%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; color: white; backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.2); cursor: pointer; transition: 0.2s; }
    .btn-circle:active { scale: 0.9; }

    video, iframe { width: 100%; border-radius: 8px; background: #000; border: none; }
    .profile-cover { width: 100%; height: 160px; background: linear-gradient(45deg, #1c1c1d, #3a3b3c); border-radius: 12px 12px 0 0; object-fit: cover; }
    .profile-avatar-pos { margin-top: -50px; position: relative; display: inline-block; }
    
    .animate-up { animation: slideUp 0.3s ease-out forwards; }
    @keyframes slideUp { from { transform: translateY(15px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    .reac-bar { display: flex; gap: 8px; padding: 4px 12px; background: #3a3b3c; border-radius: 20px; width: fit-content; }
    .reac-btn { font-size: 13px; display: flex; align-items: center; gap: 5px; font-weight: bold; color: #b0b3b8; cursor: pointer; transition: 0.2s; }
    .reac-btn.active { color: #D4AF37; scale: 1.1; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- CONFIGURACI√ìN ---
    const LOGO_URL = "https://scontent.fsyq4-1.fna.fbcdn.net/v/t39.30808-6/641550060_26884659304454362_7081351474910011629_n.jpg?stp=dst-jpg_p526x296_tt6&_nc_cat=111&ccb=1-7&_nc_sid=13d280&_nc_ohc=2LBns0CevfsQ7kNvwGlaNgn&_nc_oc=AdnqNvceRNeNnJ7J7q5yw0i7Ow-UQZmlazarAScWYjEkBWbR_T2vA4svJ-IEGcvRnSJzVKGqgr75IiSxmhCIcgqe&_nc_zt=23&_nc_ht=scontent.fsyq4-1.fna&_nc_gid=Pxa5MTpWa5LZyLPx7a5hAw&oh=00_AfuuOZe5aSrlizfZJTik_IantMTGcmfCdmixhR_TnwI0-g&oe=69A2BC7D";
    const DEFAULT_COVER = "https://images.unsplash.com/photo-1501281668745-f7f57925c3b4?auto=format&fit=crop&q=80&w=1000";
    const apiKey = ""; 

    const firebaseConfig = {
      apiKey: "AIzaSyDquU86YIWcujUgTLwoJPZcrxRBjNGLkz4", 
      authDomain: "project-a972c4a3-b179-439a-9a5.firebaseapp.com",
      projectId: "project-a972c4a3-b179-439a-9a5",
      storageBucket: "project-a972c4a3-b179-439a-9a5.firebasestorage.app",
      appId: "1:501639945234:web:e72c02f89beb3b86540ccb"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const rootId = "comunidad-davar-v300-multi-device";

    // --- UTILIDADES ---
    const compress = (file) => new Promise((res) => {
      const r = new FileReader(); r.readAsDataURL(file); r.onload = (e) => res(e.target.result);
    });

    // --- COMPONENTES ---

    const UrlPlayer = ({ url }) => {
      const getID = (u) => {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = u.match(regExp); return (match && match[2].length === 11) ? match[2] : null;
      };
      const id = getID(url);
      if (id) return <div className="rounded-lg overflow-hidden border border-white/10 mb-2"><iframe className="aspect-video w-full" src={`https://www.youtube.com/embed/${id}`} allowFullScreen /></div>;
      return <a href={url} target="_blank" className="p-3 bg-blue-500/10 rounded-lg block text-blue-400 font-bold truncate text-[11px] mb-2"><i className="fa-solid fa-link mr-2"></i> Abrir contenido ministerial</a>;
    };

    const ChatGlobal = ({ profile }) => {
      const [msgs, setMsgs] = useState([]); const [txt, setTxt] = useState('');
      const col = db.collection('artifacts').doc(rootId).collection('public').doc('data').collection('chat');
      const endRef = useRef(null);
      useEffect(() => { const unsub = col.orderBy('at','asc').limitToLast(50).onSnapshot(s => setMsgs(s.docs.map(d=>d.data()))); return ()=>unsub(); }, []);
      useEffect(() => { endRef.current?.scrollIntoView(); }, [msgs]);
      const send = () => { if(!txt.trim()) return; col.add({uid:profile.uid, name:profile.name, text:txt.trim(), photo:profile.photo, at:Date.now()}); setTxt(''); };
      return (
        <div className="h-full flex flex-col card-fb overflow-hidden animate-up">
          <div className="p-3 border-b border-white/5 bg-black/20 text-center font-black text-[#D4AF37] uppercase text-[10px] tracking-widest">Chat Ministerial</div>
          <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar bg-black/5">
            {msgs.map((m,i)=>(
              <div key={i} className={`flex gap-2 ${m.uid===profile.uid?'flex-row-reverse':''}`}>
                <img src={m.photo||LOGO_URL} className="h-7 w-7 rounded-full object-cover border border-[#D4AF37]/30" />
                <div className={`p-2.5 rounded-2xl text-[12px] max-w-[80%] ${m.uid===profile.uid?'bg-[#D4AF37] text-black font-bold':'bg-[#3a3b3c] text-white'}`}>{m.text}</div>
              </div>
            ))}
            <div ref={endRef} />
          </div>
          <div className="p-3 bg-black/20 flex gap-2 border-t border-white/5">
            <input type="text" value={txt} onChange={e=>setTxt(e.target.value)} placeholder="Mensaje..." className="flex-1 bg-white/5 text-white rounded-full px-5 text-xs outline-none" onKeyDown={e=>e.key==='Enter'&&send()} />
            <button onClick={send} className="w-10 h-10 rounded-full bg-[#D4AF37] text-black flex items-center justify-center active:scale-90"><i className="fa-solid fa-paper-plane text-sm"></i></button>
          </div>
        </div>
      );
    };

    const WisdomPanel = () => {
      const [chat, setChat] = useState([]); const [val, setVal] = useState(''); const [load, setLoad] = useState(false);
      const end = useRef(null);
      const ask = async () => {
        if(!val.trim() || load) return; const q = val; setVal(''); setChat(p => [...p, {role:'u', text:q}]); setLoad(true);
        try {
          const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method:'POST', body: JSON.stringify({ contents:[{parts:[{text:q}]}], systemInstruction:{parts:[{text:"Eres el Sabio de Davar. Responde con visi√≥n espiritual y gracia."}]} })
          });
          const d = await r.json(); setChat(p => [...p, {role:'ai', text: d.candidates?.[0]?.content?.parts?.[0]?.text || "El Creador nos invita a la calma."}]);
        } catch(e) { setChat(p => [...p, {role:'ai', text:"Conexi√≥n d√©bil, intente luego."}]); }
        setLoad(false);
      };
      useEffect(() => { end.current?.scrollIntoView({behavior:'smooth'}); }, [chat]);
      return (
        <div className="h-[70vh] flex flex-col card-fb overflow-hidden animate-up border border-[#D4AF37]/20">
          <div className="p-4 bg-[#D4AF37] text-black font-black uppercase text-[10px] text-center">Sabidur√≠a Davar</div>
          <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-black/10 custom-scrollbar">
            {chat.map((m,i)=>(<div key={i} className={`flex ${m.role==='ai'?'justify-start':'justify-end'}`}><div className={`p-3 rounded-xl text-[13px] max-w-[85%] ${m.role==='ai'?'bg-[#1c1c1d] border border-[#D4AF37]/30 text-white':'bg-[#D4AF37] text-black font-bold'}`}>{m.text}</div></div>))}
            {load && <div className="text-[#D4AF37] text-[10px] font-black animate-pulse">CONSULTANDO...</div>}
            <div ref={end} />
          </div>
          <div className="p-3 flex gap-2 bg-black/40"><input type="text" value={val} onChange={e=>setVal(e.target.value)} placeholder="Duda espiritual..." className="flex-1 bg-white/5 text-white rounded-full px-5 text-xs outline-none" onKeyDown={e=>e.key==='Enter'&&ask()} /><button onClick={ask} className="w-10 h-10 rounded-full bg-[#D4AF37] text-black flex items-center justify-center"><i className="fa-solid fa-sparkles"></i></button></div>
        </div>
      );
    };

    const LiveWindow = ({ profile, bId, isB, onClose, onPub }) => {
      const vR = useRef(null); const sR = useRef(null); const mR = useRef(null); const chunks = useRef([]);
      const [live, setLive] = useState(false);
      const start = async () => {
        try {
          const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:true});
          sR.current = s; if(vR.current) vR.current.srcObject = s;
        } catch(e) { alert("Permita c√°mara."); }
      };
      useEffect(() => { if(isB) start(); return () => sR.current?.getTracks().forEach(t=>t.stop()); }, []);
      const goLive = async () => {
        setLive(true); mR.current = new MediaRecorder(sR.current, {videoBitsPerSecond:100000}); chunks.current = [];
        mR.current.ondataavailable = e => chunks.current.push(e.data);
        mR.current.onstop = () => {
          const b = new Blob(chunks.current, {type:'video/webm'}); const r = new FileReader(); r.readAsDataURL(b);
          r.onloadend = () => { onPub(r.result); onClose(); };
        };
        mR.current.start();
        await db.collection('artifacts').doc(rootId).collection('public').doc('data').collection('lives').doc(bId).set({uid:bId, name:profile.name, photo:profile.photo, at:Date.now()});
      };
      const stop = async () => {
        if(isB && mR.current?.state === 'recording') mR.current.stop();
        await db.collection('artifacts').doc(rootId).collection('public').doc('data').collection('lives').doc(bId).delete();
        if(!isB) onClose();
      };
      return (
        <div className="full-live-container animate-up">
          <div className="flex-1 bg-black relative flex items-center justify-center">
            {isB ? <video ref={vR} muted playsInline autoPlay className="w-full h-full object-cover" /> : <iframe src={`https://meet.jit.si/Davar_${bId}`} className="w-full h-full" />}
            <div className="absolute top-10 left-5 bg-black/40 p-2 pr-4 rounded-full flex items-center gap-3 border border-white/10"><img src={profile.photo} className="h-8 w-8 rounded-full border-2 border-[#D4AF37]" /><p className="text-white font-black text-[10px] uppercase">¬°EN VIVO!</p></div>
            <div className="live-controls">
              <button onClick={onClose} className="btn-circle"><i className="fa-solid fa-xmark"></i></button>
              {isB && !live && <button onClick={goLive} className="btn-circle bg-red-600 animate-pulse"><i className="fa-solid fa-play"></i></button>}
              {(live || !isB) && <button onClick={stop} className="btn-circle bg-white text-red-600"><i className="fa-solid fa-stop"></i></button>}
            </div>
          </div>
        </div>
      );
    };

    const Wall = ({ user, profile, onStartLive, onJoinLive }) => {
      const [posts, setPosts] = useState([]); const [activeLives, setLives] = useState([]);
      const [txt, setTxt] = useState(''); const [img, setImg] = useState(''); const [vid, setVid] = useState(''); const [aud, setAud] = useState(''); const [link, setLink] = useState('');
      const [load, setLoad] = useState(false); const [commIn, setCommIn] = useState({});
      const colP = db.collection('artifacts').doc(rootId).collection('public').doc('data').collection('posts');
      const colL = db.collection('artifacts').doc(rootId).collection('public').doc('data').collection('lives');

      useEffect(() => {
        const u1 = colP.orderBy('at', 'desc').onSnapshot(s => setPosts(s.docs.map(d=>({id:d.id, ...d.data()}))));
        const u2 = colL.onSnapshot(s => setLives(s.docs.map(d=>({id:d.id, ...d.data()}))));
        return () => { u1(); u2(); };
      }, []);

      const publish = async () => {
        if(load) return; if(!txt.trim() && !img && !vid && !aud && !link.trim()) return;
        setLoad(true);
        try {
          await colP.add({ uid:user.uid, author:profile.name, photo:profile.photo, text:txt, img, video:vid, audio:aud, link, at:Date.now(), reactions:{}, comments:[] });
          setTxt(''); setImg(''); setVid(''); setAud(''); setLink('');
        } catch(e) {}
        setLoad(false);
      };

      const react = async (pId, type) => {
        const p = posts.find(x=>x.id===pId); if(!p) return; const rs = {...(p.reactions||{})};
        if(rs[user.uid]===type) delete rs[user.uid]; else rs[user.uid]=type;
        await colP.doc(pId).update({ reactions:rs });
      };

      const comment = async (pId) => {
        const ctxt = commIn[pId]; if(!ctxt?.trim()) return;
        await colP.doc(pId).update({ comments: firebase.firestore.FieldValue.arrayUnion({ name:profile.name, photo:profile.photo, text:ctxt, at:Date.now() }) });
        setCommIn(p => ({...p, [pId]:''}));
      };

      return (
        <div className="space-y-4 pb-20 animate-up text-left">
          {activeLives.map(l => (
            <div key={l.id} className="bg-red-600 p-3 rounded-xl flex items-center justify-between animate-pulse shadow-lg"><div className="flex items-center gap-3"><img src={l.photo} className="h-8 w-8 rounded-full border border-white" /><p className="font-black text-[10px] text-white uppercase tracking-tighter">{l.name} EN VIVO</p></div><button onClick={()=>onJoinLive(l.id)} className="bg-white text-red-600 px-5 py-1.5 rounded-full font-black text-[10px]">UNIRSE</button></div>
          ))}
          <div className="card-fb p-4 border-t-2 border-[#D4AF37]/30 shadow-xl">
            <div className="flex gap-3 mb-4"><img src={profile.photo} className="h-10 w-10 rounded-full border-2 border-[#D4AF37] object-cover" /><textarea placeholder={`¬øQu√© inspiraci√≥n hoy?`} value={txt} onChange={e=>setTxt(e.target.value)} className="w-full bg-[#1a1a1b] rounded-xl p-3 text-sm outline-none h-16 resize-none" /></div>
            <div className="flex flex-wrap gap-2 items-center border-t border-white/5 pt-3">
              <button onClick={onStartLive} className="text-red-500 p-2"><i className="fa-solid fa-clapperboard"></i></button>
              <label className="text-green-500 p-2 cursor-pointer"><i className="fa-solid fa-image"></i><input type="file" className="hidden" accept="image/*" onChange={async e=>setImg(await compress(e.target.files[0]))} /></label>
              <label className="text-blue-400 p-2 cursor-pointer"><i className="fa-solid fa-video"></i><input type="file" className="hidden" accept="video/*" onChange={async e=>setVid(await compress(e.target.files[0]))} /></label>
              <button onClick={()=>{const u=prompt("Enlace:"); if(u) setLink(u)}} className="text-orange-400 p-2"><i className="fa-solid fa-paperclip"></i></button>
              <button onClick={publish} disabled={load} className="ml-auto bg-[#D4AF37] text-black px-6 py-1.5 rounded-lg font-black text-[10px] uppercase shadow-md active:scale-95 transition-all">{load?'...':'Publicar'}</button>
            </div>
          </div>
          {posts.map(p => (
            <div key={p.id} className="card-fb overflow-hidden mb-4 shadow-lg animate-up border border-white/5">
              <div className="p-4 flex gap-3"><img src={p.photo} className="h-9 w-9 rounded-full border border-[#D4AF37]/30" /><div><p className="font-bold text-[13px]">{p.author}</p><p className="text-[9px] text-gray-500 uppercase">{new Date(p.at).toLocaleString()}</p></div></div>
              {p.text && <p className="px-5 pb-3 text-[14px] leading-relaxed">{p.text}</p>}
              {p.img && <img src={p.img} className="w-full border-y border-white/5" />}
              {p.video && <video src={p.video} controls className="w-full" />}
              {p.audio && <div className="px-4 pb-4"><audio src={p.audio} controls className="w-full" /></div>}
              {p.link && <div className="px-4 pb-2"><UrlPlayer url={p.link} /></div>}
              <div className="p-3 border-t border-white/5 bg-black/5">
                <div className="reac-bar mb-3">
                  <button onClick={()=>react(p.id,'amen')} className={`reac-btn ${p.reactions?.[user.uid]==='amen'?'active':''}`}>üôè Am√©n <span className="text-[10px] opacity-60 ml-1">{Object.values(p.reactions||{}).filter(r=>r==='amen').length||''}</span></button>
                  <button onClick={()=>react(p.id,'bendice')} className={`reac-btn ${p.reactions?.[user.uid]==='bendice'?'active':''}`}>üåü Bendice <span className="text-[10px] opacity-60 ml-1">{Object.values(p.reactions||{}).filter(r=>r==='bendice').length||''}</span></button>
                </div>
                <div className="space-y-2">
                  {p.comments?.map((c,idx)=>(<div key={idx} className="flex gap-2 items-start"><img src={c.photo} className="h-6 w-6 rounded-full" /><div className="bg-[#3a3b3c] p-2 rounded-xl text-[12px]"><p className="font-bold text-[9px] text-[#D4AF37] uppercase">{c.name}</p><p>{c.text}</p></div></div>))}
                  <div className="flex gap-2 pt-2"><input type="text" value={commIn[p.id]||''} onChange={e=>setCommIn(old=>({...old, [p.id]:e.target.value}))} placeholder="Comentar..." className="flex-1 bg-white/5 rounded-full px-4 text-xs outline-none border border-white/10 h-8" onKeyDown={e=>e.key==='Enter'&&comment(p.id)} /><button onClick={()=>comment(p.id)} className="text-[#D4AF37]"><i className="fa-solid fa-paper-plane"></i></button></div>
                </div>
              </div>
            </div>
          ))}
        </div>
      );
    };

    // --- APP ---
    function App() {
      const [user, setUser] = useState(null); const [profile, setProfile] = useState(null);
      const [isAuth, setIsAuth] = useState(sessionStorage.getItem('davar_auth') === 'true');
      const [tab, setTab] = useState('feed'); const [code, setCode] = useState('');
      const [isUnlocked, setUnlocked] = useState(sessionStorage.getItem('davar_unlocked') === 'true');
      const [pinIn, setPinIn] = useState(''); const [isBroad, setIsBroad] = useState(false); const [liveId, setLiveId] = useState(null);
      const [editP, setEditP] = useState(false); const [newName, setNewName] = useState(''); const [newPin, setNewPin] = useState('');

      useEffect(() => {
        const u = auth.onAuthStateChanged(async (cur) => {
          if (cur) {
            setUser(cur); const doc = await db.collection('artifacts').doc(rootId).collection('public').doc('data').collection('profiles').doc(cur.uid).get();
            if(doc.exists) { setProfile(doc.data()); setIsAuth(true); setNewName(doc.data().name); setNewPin(doc.data().pin); }
          } else { try { await auth.signInAnonymously(); } catch(e){} }
        });
        return () => u();
      }, []);

      const goHome = () => { setTab('feed'); setLiveId(null); setIsBroad(false); setEditP(false); };
      const logIn = (e) => { e.preventDefault(); if(code==="davar2026"||code==="guia2026") { setIsAuth(true); sessionStorage.setItem('davar_auth','true'); } else alert("Clave Incorrecta"); };
      const unlock = (e) => { e.preventDefault(); if(pinIn===profile.pin) { setUnlocked(true); sessionStorage.setItem('davar_unlocked','true'); } else alert("PIN Incorrecto"); };
      const reg = async (n, p) => {
        const prof = {uid:user.uid, name:n, pin:p, photo:LOGO_URL, cover:DEFAULT_COVER, at:Date.now()};
        await db.collection('artifacts').doc(rootId).collection('public').doc('data').collection('profiles').doc(user.uid).set(prof);
        setProfile(prof); setUnlocked(true); sessionStorage.setItem('davar_unlocked','true');
      };
      const updateProf = async () => {
        const upd = { name:newName, pin:newPin }; await db.collection('artifacts').doc(rootId).collection('public').doc('data').collection('profiles').doc(user.uid).update(upd);
        setProfile(prev => ({...prev, ...upd})); setEditP(false);
      };
      const media = async (f) => {
        const i = document.createElement('input'); i.type='file'; i.accept='image/*';
        i.onchange = async (e) => { const r = await compress(e.target.files[0]); await db.collection('artifacts').doc(rootId).collection('public').doc('data').collection('profiles').doc(user.uid).update({[f]:r}); setProfile(p=>({...p, [f]:r})); };
        i.click();
      };

      if(!user) return <div className="h-screen bg-black flex items-center justify-center animate-pulse text-[#D4AF37] font-black italic">Davar...</div>;
      if(!isAuth) return ( <div className="h-screen flex items-center justify-center p-6 bg-[#0f0f0f]"><div className="card-fb p-10 w-full max-w-md text-center border-t-4 border-[#D4AF37] animate-up shadow-2xl"><img src={LOGO_URL} className="w-20 h-20 mx-auto mb-6 rounded-full border-2 border-[#D4AF37]" /><h2 className="text-[#D4AF37] font-black italic mb-6">Comunidad Davar</h2><form onSubmit={logIn} className="space-y-4"><input type="password" placeholder="Clave Global" value={code} onChange={e=>setCode(e.target.value)} className="w-full p-4 rounded-xl bg-[#3a3b3c] text-white outline-none" required /><button type="submit" className="w-full bg-[#D4AF37] text-black font-black py-4 rounded-xl shadow-lg active:scale-95">Entrar</button></form></div></div> );
      if(!profile) return ( <div className="h-screen flex items-center justify-center p-6 bg-[#0f0f0f]"><div className="card-fb p-8 w-full max-w-md animate-up shadow-2xl"><h3 className="text-[#D4AF37] font-black text-center mb-6">Registro Ministerial</h3><button onClick={()=>{const n=prompt("Nombre:"); const p=prompt("Crea tu PIN Personal:"); if(n && p) reg(n,p)}} className="w-full bg-[#D4AF37] text-black font-black py-4 rounded-xl">Registrarse en la Familia</button></div></div> );
      if(!isUnlocked) return ( <div className="h-screen flex items-center justify-center p-6 bg-[#0f0f0f]"><div className="card-fb p-10 w-full max-w-md text-center border-t-4 border-[#D4AF37] animate-up shadow-2xl"><img src={profile.photo} className="w-24 h-24 mx-auto mb-4 rounded-full border-4 border-[#D4AF37] object-cover" /><h2 className="text-white font-black mb-1 uppercase">{profile.name}</h2><p className="text-gray-500 text-[10px] uppercase font-black mb-8 italic">Ingrese PIN Ministerial</p><form onSubmit={unlock} className="space-y-6"><input type="password" placeholder="PIN" value={pinIn} onChange={e=>setPinIn(e.target.value)} className="w-full p-4 rounded-xl bg-[#3a3b3c] text-white outline-none text-center text-3xl font-black tracking-[0.5em]" required autoFocus /><button type="submit" className="w-full bg-[#D4AF37] text-black font-black py-4 rounded-xl active:scale-95">Abrir Aposento</button></form></div></div> );

      return (
        <div className="h-screen flex flex-col md:flex-row overflow-hidden bg-[#0f0f0f]">
          <aside className="hidden md:flex w-[260px] flex-col bg-[#1c1c1d] border-r border-white/5 p-6 shadow-2xl">
            <button onClick={goHome} className="flex items-center gap-3 mb-10 group"><img src={LOGO_URL} className="h-9 w-9 rounded-full border border-[#D4AF37] group-hover:rotate-12 transition-all" /><span className="font-black text-[#D4AF37] text-sm uppercase">Davar Home</span></button>
            <nav className="flex-1 space-y-1">
              <SidebarLink icon="fa-house" text="Muro" active={tab==='feed'} onClick={goHome} />
              <SidebarLink icon="fa-comments" text="Chat" active={tab==='chat'} onClick={()=>setTab('chat')} />
              <SidebarLink icon="fa-sparkles" text="Sabidur√≠a" active={tab==='wisdom'} onClick={()=>setTab('wisdom')} />
              <SidebarLink icon="fa-user-gear" text="Perfil" active={tab==='profile'} onClick={()=>setTab('profile')} />
            </nav>
            <button onClick={()=>{sessionStorage.clear(); window.location.reload();}} className="mt-8 flex items-center gap-4 p-4 text-red-500 font-black uppercase text-[10px] hover:bg-red-500/10 rounded-xl transition-all"><i className="fa-solid fa-power-off"></i> Salir</button>
          </aside>
          
          <main className="flex-1 flex flex-col h-full relative overflow-hidden">
            <header className="md:hidden bg-[#242526] p-4 border-b border-[#3e4042] flex items-center justify-between sticky top-0 z-50 shadow-lg"><button onClick={goHome} className="text-[#D4AF37]"><i className="fa-solid fa-house text-lg"></i></button><div className="font-black text-[#D4AF37] uppercase text-[11px] italic">Comunidad Davar</div><img src={profile.photo} onClick={()=>setTab('profile')} className="h-9 w-9 rounded-full border border-[#D4AF37] object-cover" /></header>
            <div className="flex-1 overflow-y-auto p-3 md:p-8 flex justify-center custom-scrollbar">
              <div className={`w-full ${(tab==='chat' || tab==='wisdom') ? 'max-w-[1100px]' : 'max-w-[650px]'} transition-all`}>
                {tab==='feed' && <Wall user={user} profile={profile} onStartLive={()=>setIsBroad(true)} onJoinLive={id=>setLiveId(id)} />}
                {tab==='chat' && (
                  <div className="grid grid-cols-1 md:grid-cols-12 gap-6 h-[80vh] animate-up">
                    <div className="hidden md:block md:col-span-7 overflow-y-auto custom-scrollbar h-full pr-4"><Wall user={user} profile={profile} onStartLive={()=>setIsBroad(true)} onJoinLive={id=>setLiveId(id)} /></div>
                    <div className="col-span-1 md:col-span-5 h-full"><ChatGlobal profile={profile} /></div>
                  </div>
                )}
                {tab==='wisdom' && <WisdomPanel />}
                {tab==='profile' && (
                  <div className="card-fb overflow-hidden animate-up shadow-2xl border-t-4 border-[#D4AF37]/50">
                    <div className="relative h-40"><img src={profile.cover} className="profile-cover h-full w-full" /><button onClick={()=>media('cover')} className="absolute top-4 right-4 bg-black/40 p-2 rounded-full text-white shadow-lg"><i className="fa-solid fa-camera"></i></button></div>
                    <div className="p-8 pt-0 text-center">
                      <div className="profile-avatar-pos"><img src={profile.photo} className="w-28 h-28 rounded-full border-4 border-[#242526] object-cover shadow-2xl" /><button onClick={()=>media('photo')} className="absolute bottom-1 right-1 bg-[#D4AF37] p-2 rounded-full text-black shadow-lg"><i className="fa-solid fa-camera text-xs"></i></button></div>
                      {!editP ? (
                        <>
                          <h2 className="font-black text-xl mt-4 uppercase italic">{profile.name}</h2>
                          <p className="text-[10px] text-gray-500 uppercase mt-1 mb-8 tracking-widest">Siervo del Ministerio</p>
                          <div className="flex flex-col gap-3"><button onClick={()=>setEditP(true)} className="w-full bg-white/5 border border-white/10 text-white py-3 rounded-xl font-black uppercase text-[10px] tracking-widest hover:bg-white/10 transition-all">Editar Perfil</button><button onClick={goHome} className="w-full bg-[#D4AF37] text-black py-4 rounded-xl font-black uppercase shadow-lg active:scale-95 transition-all">Regresar al Muro</button></div>
                        </>
                      ) : (
                        <div className="mt-6 space-y-4 text-left">
                          <div><label className="text-[9px] font-black uppercase text-gray-500 ml-2">Nombre</label><input type="text" value={newName} onChange={e=>setNewName(e.target.value)} className="w-full bg-[#3a3b3c] p-3 rounded-lg outline-none" /></div>
                          <div><label className="text-[9px] font-black uppercase text-gray-500 ml-2">PIN Secreto</label><input type="text" value={newPin} onChange={e=>setNewPin(e.target.value)} className="w-full bg-[#3a3b3c] p-3 rounded-lg outline-none" /></div>
                          <div className="flex gap-2 pt-4"><button onClick={()=>setEditP(false)} className="flex-1 bg-white/5 py-3 rounded-lg text-xs font-bold">Cancelar</button><button onClick={updateProf} className="flex-1 bg-[#D4AF37] text-black py-3 rounded-lg text-xs font-black uppercase">Guardar Cambios</button></div>
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>
            <nav className="md:hidden fixed bottom-0 w-full bg-[#1c1c1d] border-t border-[#3e4042] flex justify-around items-center h-[65px] z-50 px-2 shadow-2xl">
              <button onClick={goHome} className={`flex-1 flex flex-col items-center ${tab==='feed'?'text-[#D4AF37]':'text-gray-500'}`}><i className="fa-solid fa-house text-lg"></i></button>
              <button onClick={()=>setTab('chat')} className={`flex-1 flex flex-col items-center ${tab==='chat'?'text-[#D4AF37]':'text-gray-500'}`}><i className="fa-solid fa-comments text-lg"></i></button>
              <button onClick={()=>setTab('wisdom')} className={`flex-1 flex flex-col items-center ${tab==='wisdom'?'text-[#D4AF37]':'text-gray-500'}`}><i className="fa-solid fa-sparkles text-lg"></i></button>
              <button onClick={()=>setTab('profile')} className={`flex-1 flex flex-col items-center ${tab==='profile'?'text-[#D4AF37]':'text-gray-500'}`}><i className="fa-solid fa-user text-lg"></i></button>
            </nav>
          </main>
          {isBroad && <LiveWindow profile={profile} bId={user.uid} isB={true} onClose={()=>setIsBroad(false)} onPub={()=>{}} />}
          {liveId && <LiveWindow profile={profile} bId={liveId} isB={false} onClose={()=>setLiveId(null)} />}
        </div>
      );
    }

    function SidebarLink({ icon, text, active, onClick }) {
      return (
        <button onClick={onClick} className={`w-full flex items-center gap-4 p-4 rounded-xl transition-all ${active ? 'nav-active shadow-lg' : 'text-gray-500 hover:bg-white/5 hover:text-gray-300'}`}>
          <i className={`fa-solid ${icon} w-5 text-center`}></i>
          <span className="font-black uppercase text-[10px] tracking-widest">{text}</span>
        </button>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
