<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Comunidad Davar - Red Ministerial</title>
  
  <!-- Identidad Visual Sagrada -->
  <link rel="icon" type="image/jpg" href="https://scontent.fsyq4-1.fna.fbcdn.net/v/t39.30808-6/641550060_26884659304454362_7081351474910011629_n.jpg?stp=dst-jpg_p526x296_tt6&_nc_cat=111&ccb=1-7&_nc_sid=13d280&_nc_ohc=2LBns0CevfsQ7kNvwGlaNgn&_nc_oc=AdnqNvceRNeNnJ7J7q5yw0i7Ow-UQZmlazarAScWYjEkBWbR_T2vA4svJ-IEGcvRnSJzVKGqgr75IiSxmhCIcgqe&_nc_zt=23&_nc_ht=scontent.fsyq4-1.fna&_nc_gid=Pxa5MTpWa5LZyLPx7a5hAw&oh=00_AfuuOZe5aSrlizfZJTik_IantMTGcmfCdmixhR_TnwI0-g&oe=69A2BC7D">
  <link rel="apple-touch-icon" href="https://scontent.fsyq4-1.fna.fbcdn.net/v/t39.30808-6/641550060_26884659304454362_7081351474910011629_n.jpg?stp=dst-jpg_p526x296_tt6&_nc_cat=111&ccb=1-7&_nc_sid=13d280&_nc_ohc=2LBns0CevfsQ7kNvwGlaNgn&_nc_oc=AdnqNvceRNeNnJ7J7q5yw0i7Ow-UQZmlazarAScWYjEkBWbR_T2vA4svJ-IEGcvRnSJzVKGqgr75IiSxmhCIcgqe&_nc_zt=23&_nc_ht=scontent.fsyq4-1.fna&_nc_gid=Pxa5MTpWa5LZyLPx7a5hAw&oh=00_AfuuOZe5aSrlizfZJTik_IantMTGcmfCdmixhR_TnwI0-g&oe=69A2BC7D">
  <meta name="mobile-web-app-capable" content="yes">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase v10 Compat -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

  <style>
    :root { --fb-blue: #1877F2; --fb-bg: #F0F2F5; --fb-white: #FFFFFF; --davar-gold: #D4AF37; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--fb-bg); margin: 0; color: #1C1E21; overflow: hidden; height: 100vh; }
    
    /* Header Superior Amplio y Azul */
    .header-fb { background: var(--fb-white); height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; position: fixed; top: 0; width: 100%; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-bottom: 1px solid #e4e6eb; }
    .nav-container { display: flex; flex: 1; justify-content: center; max-width: 900px; gap: clamp(8px, 3.5vw, 55px); }
    
    .nav-icon { height: 60px; min-width: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--fb-blue); border-bottom: 4px solid transparent; transition: 0.2s; position: relative; opacity: 0.6; }
    .nav-icon.active { opacity: 1; border-bottom-color: var(--fb-blue); }
    .nav-icon:hover:not(.active) { background: #F2F2F2; border-radius: 12px; opacity: 1; }
    .nav-icon i { font-size: 24px; }

    /* Logo CD Est√©tico (Acceso Admin Oculto) */
    .logo-cd { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--fb-blue), #004fb1); display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid var(--davar-gold); box-shadow: 0 2px 5px rgba(0,0,0,0.2); flex-shrink: 0; cursor: pointer; }
    .logo-cd .initials { color: white; font-weight: 900; font-size: 16px; line-height: 1; letter-spacing: -1px; }
    .logo-cd .sub-text { color: var(--davar-gold); font-size: 7px; font-weight: 900; text-transform: uppercase; margin-top: 1px; }

    .card-social { background: var(--fb-white); border-radius: 12px; border: 1px solid #dddfe2; box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 16px; overflow: hidden; position: relative; }
    .custom-scrollbar::-webkit-scrollbar { width: 5px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #bcc0c4; border-radius: 10px; }
    
    .post-opt-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 14px; font-weight: 600; color: #65676B; }
    .post-opt-btn:hover { background: #F2F2F2; }

    .live-overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; flex-direction: column; }
    .btn-circle-action { width: 44px; height: 44px; border-radius: 50%; background: rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: 0.2s; }
    .btn-circle-action:active { scale: 0.9; }

    video, iframe { width: 100%; border-radius: 12px; background: #000; border: none; }
    .profile-banner { width: 100%; height: 220px; background: #ccd0d5; object-fit: cover; }
    .avatar-view { margin-top: -80px; position: relative; display: inline-block; border: 5px solid white; border-radius: 50%; background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
    
    .animate-up { animation: slideUp 0.3s ease-out forwards; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

    .reac-btn { font-size: 14px; display: flex; align-items: center; gap: 6px; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; color: #65676B; transition: 0.1s; }
    .reac-btn:hover { background: #F2F2F2; }
    .reac-btn.active { color: var(--fb-blue); font-weight: 800; }

    .input-pill { background: #F0F2F5; border-radius: 20px; padding: 12px 18px; border: 1px solid transparent; outline: none; width: 100%; font-size: 15px; transition: 0.2s; }
    .input-pill:focus { background: #fff; border-color: var(--fb-blue); }

    .emoji-panel { display: grid; grid-template-cols: repeat(5, 1fr); gap: 10px; padding: 15px; background: white; border: 1px solid #ddd; border-radius: 12px; position: absolute; z-index: 100; bottom: 70px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 280px; }

    @media (max-width: 640px) {
      .header-fb { padding: 0 10px; height: 60px; }
      .nav-container { gap: clamp(5px, 2vw, 20px); }
      .nav-icon { min-width: 40px; }
      .nav-icon i { font-size: 22px; }
      .hide-mobile-text { display: none; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- CONFIG FIREBASE ---
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      apiKey: "AIzaSyDquU86YIWcujUgTLwoJPZcrxRBjNGLkz4", 
      authDomain: "project-a972c4a3-b179-439a-9a5.firebaseapp.com",
      projectId: "project-a972c4a3-b179-439a-9a5",
      storageBucket: "project-a972c4a3-b179-439a-9a5.firebasestorage.app",
      appId: "1:501639945234:web:e72c02f89beb3b86540ccb"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // RUTA PRINCIPAL SANADA
    const appId = typeof __app_id !== 'undefined' ? __app_id : "comunidad-davar-v2026-libre";
    
    const LOGO_URL = "https://scontent.fsyq4-1.fna.fbcdn.net/v/t39.30808-6/641550060_26884659304454362_7081351474910011629_n.jpg?stp=dst-jpg_p526x296_tt6&_nc_cat=111&ccb=1-7&_nc_sid=13d280&_nc_ohc=2LBns0CevfsQ7kNvwGlaNgn&_nc_oc=AdnqNvceRNeNnJ7J7q5yw0i7Ow-UQZmlazarAScWYjEkBWbR_T2vA4svJ-IEGcvRnSJzVKGqgr75IiSxmhCIcgqe&_nc_zt=23&_nc_ht=scontent.fsyq4-1.fna&_nc_gid=Pxa5MTpWa5LZyLPx7a5hAw&oh=00_AfuuOZe5aSrlizfZJTik_IantMTGcmfCdmixhR_TnwI0-g&oe=69A2BC7D";
    const DEFAULT_COVER = "https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=1000";
    const apiKeyGemini = ""; 

    // --- UTILS ---
    const optimizeMedia = (file) => new Promise((res) => {
      const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (e) => res(e.target.result);
    });

    // --- BANNER DE INFILTRADOS (1 HORA M√ÅXIMO) ---
    function GuestBanner({ user }) {
        const [timeLeft, setTimeLeft] = useState(60);
        useEffect(() => {
            if(!user || !user.metadata || !user.metadata.creationTime) return;
            const checkTime = () => {
                const created = new Date(user.metadata.creationTime).getTime();
                const elapsed = Date.now() - created;
                const remaining = 60 - Math.floor(elapsed / 60000);
                if (remaining <= 0) {
                    sessionStorage.clear();
                    auth.signOut().then(() => window.location.reload());
                } else {
                    setTimeLeft(remaining);
                }
            };
            checkTime();
            const int = setInterval(checkTime, 60000);
            return () => clearInterval(int);
        }, [user]);

        return (
            <div className="bg-red-600 text-white text-center py-2 px-4 text-[10px] sm:text-xs font-black uppercase tracking-widest animate-pulse z-50">
                ‚è≥ Visitante: Tienes {timeLeft} minutos para crear tu cuenta en la pesta√±a "Perfil" o ser√°s desconectado.
            </div>
        );
    }

    // --- COMPONENTES PRINCIPALES ---
    const MediaDisplay = ({ url }) => {
      if (!url) return null;
      if (url.match(/\.(jpeg|jpg|gif|png|webp)$/) != null || url.includes('images.unsplash.com') || url.startsWith('data:image')) {
        return <div className="mt-3 animate-up"><img src={url} className="w-full rounded-xl border shadow-sm" alt="Imagen ministerial" /></div>;
      }
      if (url.includes('spotify.com')) {
        const embedUrl = url.replace('open.spotify.com/', 'open.spotify.com/embed/');
        return <div className="mt-3 shadow-md rounded-xl overflow-hidden"><iframe src={embedUrl} width="100%" height="80" frameBorder="0" allowtransparency="true" allow="encrypted-media"></iframe></div>;
      }
      const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
      const ytId = (match && match[2].length === 11) ? match[2] : null;
      if (ytId) return <div className="mt-3 overflow-hidden rounded-xl shadow-lg"><iframe className="aspect-video w-full" src={`https://www.youtube.com/embed/${ytId}`} allowFullScreen /></div>;
      return <a href={url} target="_blank" rel="noopener noreferrer" className="p-4 bg-blue-50 rounded-xl block text-blue-600 font-bold truncate text-[14px] mt-3 border border-blue-100 shadow-sm"><i className="fa-solid fa-link mr-2"></i> Abrir contenido</a>;
    };

    const LiveOverlay = ({ user, profile, bId, isB, onClose, onPub }) => {
      if (!profile || !user) return null;
      const vR = useRef(null); const sR = useRef(null); const mR = useRef(null); const chunks = useRef([]);
      const [live, setLive] = useState(false); const [paused, setPaused] = useState(false);
      
      // RUTA DE USUARIOS PARA PERMISOS
      const chatCol = db.collection('artifacts').doc(appId).collection('users').doc(bId).collection('live_msgs');
      const [chat, setChat] = useState([]); const [msg, setMsg] = useState('');

      useEffect(() => {
        if(isB) (async()=>{ try{ const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:true}); sR.current=s; if(vR.current) vR.current.srcObject=s; }catch(e){alert("Se requiere c√°mara."); onClose();}})();
        // Carga de chat segura
        const unsub = chatCol.onSnapshot(s => {
            const msgs = s.docs.map(d=>d.data()).sort((a,b) => a.at - b.at).slice(-15);
            setChat(msgs);
        }, (err) => console.log(""));
        return ()=> { if(sR.current) sR.current.getTracks().forEach(t=>t.stop()); unsub(); };
      }, []);

      const start = async () => {
        setLive(true); mR.current = new MediaRecorder(sR.current, {videoBitsPerSecond:120000}); chunks.current = [];
        mR.current.ondataavailable = e => chunks.current.push(e.data);
        mR.current.onstop = () => { const b=new Blob(chunks.current,{type:'video/webm'}); const r=new FileReader(); r.readAsDataURL(b); r.onloadend=()=>{ onPub(r.result); onClose(); }; };
        mR.current.start();
        await db.collection('artifacts').doc(appId).collection('users').doc(bId).collection('lives').doc('data').set({uid:bId, name:profile.name, photo:profile.photo, at:Date.now()});
      };
      const stopLive = async () => { if(isB && mR.current?.state !== 'inactive') mR.current.stop(); await db.collection('artifacts').doc(appId).collection('users').doc(bId).collection('lives').doc('data').delete(); if(!isB) onClose(); };
      const pause = () => { if(mR.current?.state === 'recording') { mR.current.pause(); setPaused(true); } else if(mR.current?.state === 'paused') { mR.current.resume(); setPaused(false); } };

      return (
        <div className="live-overlay animate-in">
          <div className="flex-1 bg-black relative flex items-center justify-center">
            {isB ? <video ref={vR} muted playsInline autoPlay className="w-full h-full object-cover" /> : <iframe src={`https://meet.jit.si/DavarLive_${bId}`} className="w-full h-full" />}
            <div className="absolute top-10 left-5 flex items-center gap-3 bg-black/40 p-2 pr-5 rounded-full border border-white/20 shadow-xl"><img src={profile.photo} className="h-10 w-10 rounded-full border border-white" /><p className="text-white font-black text-[10px] tracking-widest uppercase">‚óè EN VIVO</p></div>
            <div className="absolute bottom-24 left-5 max-h-[30vh] overflow-y-auto no-scrollbar w-[280px] space-y-2 pointer-events-none">
              {chat.map((c,i)=>(<div key={i} className="bg-black/30 p-2 rounded-xl text-white text-[12px] backdrop-blur-md border border-white/5 shadow-sm"><span className="font-bold text-blue-400 uppercase">{c.name}:</span> {c.text}</div>))}
            </div>
            <div className="absolute top-8 right-5 flex flex-col gap-6">
              <div onClick={onClose} className="btn-circle-action bg-gray-800 shadow-xl"><i className="fa-solid fa-xmark"></i></div>
              {isB && !live && <div onClick={start} className="btn-circle-action bg-red-600 animate-pulse shadow-xl"><i className="fa-solid fa-play"></i></div>}
              {isB && live && (
                <>
                  <div onClick={pause} className={`btn-circle-action ${paused?'bg-yellow-500':'bg-blue-600'}`}><i className={`fa-solid ${paused?'fa-play':'fa-pause'}`}></i></div>
                  <div onClick={stopLive} className="btn-circle-action bg-white text-red-600 shadow-2xl"><i className="fa-solid fa-stop"></i></div>
                  <div onClick={()=>{navigator.share({title:'VIVO - Davar', url:window.location.href}).catch(()=>{})}} className="btn-circle-action bg-blue-50"><i className="fa-solid fa-share-nodes text-blue-600"></i></div>
                </>
              )}
              {!isB && <div onClick={onClose} className="btn-circle-action bg-white text-red-600 shadow-2xl"><i className="fa-solid fa-stop"></i></div>}
            </div>
          </div>
          <div className="p-4 bg-black border-t border-white/10 flex gap-3"><input type="text" value={msg} onChange={e=>setMsg(e.target.value)} placeholder="Am√©n..." className="flex-1 bg-white/10 text-white rounded-full px-6 outline-none border border-white/10 shadow-inner" onKeyDown={e=>e.key==='Enter'&&msg.trim()&&(chatCol.add({name:profile.name,text:msg.trim(),at:Date.now()}),setMsg(''))} /><button onClick={()=>{if(!msg.trim())return; chatCol.add({name:profile.name,text:msg.trim(),at:Date.now()});setMsg('');}} className="w-12 h-12 rounded-full bg-blue-600 text-white flex items-center justify-center active:scale-90 shadow-lg"><i className="fa-solid fa-paper-plane"></i></button></div>
        </div>
      );
    };

    function WallView({ user, profile, isAdmin, onStartLive, onJoinLive }) {
      const [posts, setPosts] = useState([]); const [lives, setLives] = useState([]);
      const [txt, setTxt] = useState(''); const [img, setImg] = useState(''); const [aud, setAud] = useState(''); const [link, setLink] = useState('');
      const [loc, setLoc] = useState(''); const [tag, setTag] = useState(''); const [feeling, setFeeling] = useState('');
      const [loading, setLoading] = useState(false); const [showEmoji, setShowEmoji] = useState(false);
      const [isRecording, setIsRecording] = useState(false);
      
      // RUTA PRIVADA CORREGIDA PARA PERMISOS 
      // Dado que el Muro debe ser compartido, usamos una colecci√≥n p√∫blica general v√°lida para los permisos de Canvas
      const postCol = db.collection('artifacts').doc(appId).collection('users');
      
      useEffect(() => {
        if (!user) return;
        // Cargamos posts simulados si no hay permisos o en su defecto usamos la colecci√≥n de usuarios
        const u1 = postCol.onSnapshot(s => {
             let allPosts = [];
             s.docs.forEach(d => {
                 const data = d.data();
                 if (data.posts) allPosts = [...allPosts, ...data.posts];
             });
             const sorted = allPosts.sort((a,b) => b.at - a.at);
             setPosts(sorted);
        }, (err) => console.log(""));
        
        return () => { u1(); };
      }, [user]);

      const sendPost = async () => {
        if(loading || (!txt.trim() && !img && !aud && !link.trim() && !loc && !tag)) return;
        setLoading(true);
        try { 
          const newPost = { id: Date.now().toString(), uid:user.uid, author:profile.name, photo:profile.photo, text:txt, img, video:'', audio:aud, link, location:loc, tag, feeling, at:Date.now(), reactions:{}, comments:[] };
          // Guardamos en el perfil del usuario para asegurar permisos
          await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).set({
              posts: firebase.firestore.FieldValue.arrayUnion(newPost)
          }, { merge: true });
          
          setTxt(''); setImg(''); setAud(''); setLink(''); setLoc(''); setTag(''); setFeeling(''); setShowEmoji(false);
          document.getElementById('post-dialog').classList.add('hidden');
        } catch(e) { alert("Error al publicar."); }
        setLoading(false);
      };

      const deletePost = async (p) => {
        if(confirm("¬øDesea eliminar esta publicaci√≥n?")) {
            await db.collection('artifacts').doc(appId).collection('users').doc(p.uid).set({
                posts: firebase.firestore.FieldValue.arrayRemove(p)
            }, { merge: true });
        }
      };

      const handleAudio = async () => {
        try{
          const s = await navigator.mediaDevices.getUserMedia({ audio: true });
          const mr = new MediaRecorder(s); const ch = []; setIsRecording(true);
          mr.ondataavailable = e => ch.push(e.data);
          mr.onstop = () => { 
            const b = new Blob(ch, {type:'audio/mp3'}); const r = new FileReader(); r.readAsDataURL(b); 
            r.onloadend = () => setAud(r.result); setIsRecording(false); s.getTracks().forEach(t=>t.stop());
          };
          mr.start(); setTimeout(() => { if(mr.state === 'recording') mr.stop(); }, 45000);
        } catch(e) { setIsRecording(false); }
      };

      return (
        <div className="space-y-4 pb-24 animate-up text-left max-w-[620px] mx-auto px-1 md:px-0 mt-4">
          {lives.map(l => (
            <div key={l.id} className="bg-red-500 p-4 rounded-xl flex items-center justify-between text-white shadow-lg animate-pulse">
              <div className="flex items-center gap-3"><img src={l.photo} className="h-11 w-11 rounded-full border-2 border-white object-cover shadow-sm" /><p className="font-bold text-[14px] uppercase tracking-tighter italic">‚óè EN VIVO: {l.name}</p></div>
              <button onClick={()=>onJoinLive(l.uid)} className="bg-white text-red-600 px-6 py-2 rounded-full font-black text-[12px] active:scale-95 transition-all shadow-sm">UNIRSE</button>
            </div>
          ))}

          {!profile ? (
            <div className="card-social p-8 text-center border-2 border-red-500/30 bg-white">
              <i className="fa-solid fa-user-lock text-4xl text-gray-300 mb-4"></i>
              <h3 className="text-gray-800 font-black uppercase tracking-widest mb-2">Modo Visitante</h3>
              <p className="text-gray-500 text-sm mb-4">Para poder compartir bendiciones y comentar, debes ir a la pesta√±a <b>Perfil</b> y registrarte.</p>
            </div>
          ) : (
            <div className="card-social p-5 shadow-sm border border-gray-200 bg-white">
              <div className="flex gap-4 mb-4">
                <img src={profile.photo || LOGO_URL} className="h-12 w-12 rounded-full object-cover border-2 border-gray-100 shadow-sm" />
                <div onClick={()=>document.getElementById('post-dialog').classList.remove('hidden')} className="w-full bg-[#f0f2f5] rounded-full p-2.5 px-6 text-gray-500 text-[16px] cursor-pointer hover:bg-[#e4e6e9] transition-all shadow-inner italic flex items-center">¬øQu√© inspiraci√≥n ministerial tienes hoy?</div>
              </div>
              <div className="flex gap-1 border-t pt-2">
                <div onClick={onStartLive} className="post-opt-btn"><i className="fa-solid fa-video text-red-500 text-xl"></i><span className="hidden sm:inline">Vivo</span></div>
                <label className="post-opt-btn"><i className="fa-solid fa-image text-green-500 text-xl"></i><span className="hidden sm:inline">Foto</span><input type="file" className="hidden" accept="image/*" onChange={async e=>{setImg(await optimizeMedia(e.target.files[0])); document.getElementById('post-dialog').classList.remove('hidden');}} /></label>
                <div onClick={handleAudio} className={`post-opt-btn ${isRecording?'text-red-600 animate-pulse':'text-orange-500'}`}><i className="fa-solid fa-microphone text-xl"></i><span className="hidden sm:inline">Voz</span></div>
              </div>
            </div>
          )}
          
          <div id="post-dialog" className="hidden card-social p-6 border-2 border-blue-100 animate-in shadow-2xl relative bg-white z-50">
             <div className="flex justify-between items-center mb-5 border-b pb-3"><h3 className="font-bold text-gray-800 text-lg uppercase italic tracking-tighter">Nueva Bendici√≥n</h3><i onClick={()=>document.getElementById('post-dialog').classList.add('hidden')} className="fa-solid fa-xmark cursor-pointer p-2 bg-gray-100 rounded-full w-10 h-10 flex items-center justify-center hover:bg-gray-200 transition-all"></i></div>
             <textarea value={txt} onChange={e=>setTxt(e.target.value)} placeholder={`¬øQu√© inspiraci√≥n tienes hoy?`} className="w-full h-40 outline-none text-xl resize-none placeholder-gray-400 font-medium shadow-sm p-2 rounded-xl" />
             {(img || aud || loc || tag || feeling || link) && <div className="mt-4 p-4 bg-gray-50 rounded-2xl border border-dashed flex flex-wrap gap-4 shadow-inner">
                {img && <div className="relative"><img src={img} className="h-28 w-28 object-cover rounded-xl shadow-md" /><i onClick={()=>setImg('')} className="fa-solid fa-circle-xmark absolute -top-3 -right-3 text-black cursor-pointer bg-white rounded-full text-2xl shadow-xl"></i></div>}
                {aud && <div className="w-full flex items-center gap-2 bg-white p-3 rounded-xl border shadow-sm"><audio src={aud} controls className="h-10 flex-1" /><i onClick={()=>setAud('')} className="fa-solid fa-trash text-red-500 cursor-pointer p-2"></i></div>}
                {loc && <div className="bg-red-50 text-red-600 px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 shadow-sm border border-red-100 italic shadow-inner"><i className="fa-solid fa-location-dot"></i> {loc} <i onClick={()=>setLoc('')} className="fa-solid fa-xmark cursor-pointer"></i></div>}
                {tag && <div className="bg-blue-50 text-blue-600 px-4 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 shadow-sm border border-blue-100 italic shadow-inner"><i className="fa-solid fa-user-tag"></i> {tag} <i onClick={()=>setTag('')} className="fa-solid fa-xmark cursor-pointer"></i></div>}
                {feeling && <div className="bg-yellow-50 text-yellow-800 px-4 py-1.5 rounded-full text-xs font-bold italic shadow-sm border border-yellow-100 uppercase tracking-widest">Me siento {feeling} <i onClick={()=>setFeeling('')} className="fa-solid fa-xmark cursor-pointer"></i></div>}
                {link && <div className="w-full border p-3 rounded-xl bg-blue-50 text-[12px] truncate text-blue-800 font-bold border-blue-200 shadow-md">Enlace: {link} <i onClick={()=>setLink('')} className="fa-solid fa-xmark cursor-pointer ml-3 text-red-500"></i></div>}
             </div>}
             <div className="border rounded-2xl p-4 my-6 flex items-center justify-between shadow-sm bg-white border-gray-200">
                <div className="flex gap-6 text-2xl">
                   <i onClick={()=>setShowEmoji(!showEmoji)} className="fa-regular fa-face-smile text-yellow-500 cursor-pointer hover:scale-125 active:scale-90" title="Sentimiento"></i>
                   <i onClick={()=>{const u=prompt("YouTube/Spotify o URL de imagen web:"); if(u) setLink(u)}} className="fa-solid fa-link text-blue-500 cursor-pointer hover:scale-125 active:scale-90" title="Enlace"></i>
                   <i onClick={()=>{navigator.geolocation.getCurrentPosition(p=>setLoc(`${p.coords.latitude.toFixed(2)}, ${p.coords.longitude.toFixed(2)}`),()=>alert("GPS requerido"))}} className="fa-solid fa-location-dot text-red-500 cursor-pointer hover:scale-125 active:scale-90" title="Ubicaci√≥n"></i>
                   <i onClick={()=>{const h=prompt("Nombre del hermano:"); if(h) setTag(h)}} className="fa-solid fa-user-tag text-green-500 cursor-pointer hover:scale-125 active:scale-90" title="Etiquetar"></i>
                   <i onClick={()=>{const m=prompt("Melod√≠a espiritual:"); if(m) setTxt(p=>p+" üéµ "+m)}} className="fa-solid fa-music text-purple-500 cursor-pointer hover:scale-125 active:scale-90" title="M√∫sica"></i>
                </div>
             </div>
             {showEmoji && <div className="emoji-panel shadow-2xl border-2 border-blue-50 animate-up mb-4">{['üôè','üôå','üî•','üåü','üìñ','üïäÔ∏è','‚ù§Ô∏è','‚úùÔ∏è','‚õ™','üíé','üåà','üåç','üìú','‚ú®','üé∫'].map(e=>(<span key={e} onClick={()=>{setTxt(p=>p+e); setShowEmoji(false);}} className="text-3xl cursor-pointer hover:scale-150 transition-all text-center p-1">{e}</span>))}</div>}
             <button onClick={sendPost} disabled={loading} className="w-full bg-[#1877f2] text-white font-black py-4.5 rounded-2xl shadow-xl active:scale-95 transition-all text-[15px] uppercase h-14">{loading?'Publicando...':'Publicar Bendici√≥n'}</button>
          </div>

          {posts.map(p => (
            <div key={p.id} className="card-social animate-up border border-gray-100 shadow-sm bg-white relative">
              {(p.uid === user?.uid || isAdmin) && (
                 <button onClick={()=>deletePost(p)} className="absolute top-4 right-4 text-gray-300 hover:text-red-500 transition-colors z-10"><i className="fa-solid fa-trash-can"></i></button>
              )}
              <div className="p-5 flex gap-4 pr-10"><img src={p.photo || LOGO_URL} className="h-12 w-12 rounded-full border shadow-sm object-cover" /><div className="flex-1 text-left"><p className="font-bold text-[16px] text-gray-900 leading-none mb-1 uppercase italic">{p.author || 'An√≥nimo'} {p.feeling && <span className="font-normal text-gray-500 italic lowercase"> se siente <span className="font-bold text-gray-800 uppercase">{p.feeling}</span></span>} {p.tag && <span className="font-normal text-gray-500 italic"> con <span className="font-bold text-blue-600 uppercase">{p.tag}</span></span>}</p><p className="text-[11px] text-gray-400 font-black uppercase tracking-tighter">{new Date(p.at).toLocaleString()} {p.location && <span className="ml-2 text-red-500 font-black">‚óè {p.location}</span>}</p></div></div>
              {p.text && <p className="px-6 pb-4 text-[17px] leading-relaxed text-gray-800 whitespace-pre-wrap font-medium">{p.text}</p>}
              {p.img && <img src={p.img} className="w-full border-y border-gray-50 shadow-sm" />}
              {p.audio && <div className="px-6 py-6 bg-gray-50/50 border-y shadow-inner"><audio src={p.audio} controls className="w-full h-11" /></div>}
              {p.link && <div className="px-6 pb-6"><MediaDisplay url={p.link} /></div>}
            </div>
          ))}
        </div>
      );
    }

    function ChatPanel({ user, profile, isAdmin }) {
      const [msgs, setMsgs] = useState([]); const [txt, setTxt] = useState('');
      const col = db.collection('artifacts').doc(appId).collection('users');
      const endRef = useRef(null);
      
      useEffect(() => { 
        if(!user) return;
        const unsub = col.onSnapshot(s => {
          let allMsgs = [];
          s.docs.forEach(d => { if(d.data().messages) allMsgs = [...allMsgs, ...d.data().messages]; });
          const sortedMsgs = allMsgs.sort((a,b) => a.at - b.at).slice(-50);
          setMsgs(sortedMsgs);
        }, (err) => console.log("")); 
        return ()=>unsub(); 
      }, [user]);
      useEffect(() => { endRef.current?.scrollIntoView({behavior:'smooth'}); }, [msgs]);
      
      const send = async () => { 
          if(!txt.trim() || !profile) return; 
          const newMsg = { id: Date.now().toString(), uid:profile.uid, name:profile.name, text:txt.trim(), photo:profile.photo, at:Date.now() };
          await col.doc(user.uid).set({ messages: firebase.firestore.FieldValue.arrayUnion(newMsg) }, { merge: true });
          setTxt(''); 
      };
      
      const deleteMsg = async (m) => { 
          if(confirm("¬øEliminar este mensaje?")) await col.doc(m.uid).set({ messages: firebase.firestore.FieldValue.arrayRemove(m) }, { merge: true }); 
      };

      return (
        <div className="h-full flex flex-col card-social overflow-hidden animate-up bg-white border-t-4 border-blue-600 shadow-2xl mt-4">
          <div className="p-4 border-b text-center font-bold text-gray-500 text-[11px] uppercase tracking-widest bg-gray-50 italic shadow-sm">Chat Familiar (Solo Texto)</div>
          <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 custom-scrollbar">
            {msgs.map((m,i)=>(
              <div key={m.id} className={`flex gap-3 relative group ${m.uid===profile?.uid?'flex-row-reverse':''}`}>
                <img src={m.photo||LOGO_URL} className="h-9 w-9 rounded-full object-cover border border-gray-200 shadow-sm" />
                <div className={`p-3.5 rounded-2xl text-[14px] max-w-[80%] shadow-sm ${m.uid===profile?.uid?'bg-[#1877F2] text-white shadow-md font-medium':'bg-white text-gray-800 border border-gray-200'}`}>
                   {m.uid !== profile?.uid && <p className="text-[9px] font-black text-gray-400 mb-1 uppercase">{m.name}</p>}
                   {m.text}
                </div>
                {(m.uid === user?.uid || isAdmin) && <button onClick={()=>deleteMsg(m)} className="opacity-0 group-hover:opacity-100 text-red-500 px-2"><i className="fa-solid fa-trash-can text-xs"></i></button>}
              </div>
            ))}
            <div ref={endRef} />
          </div>
          <div className="p-4 bg-white flex gap-3 border-t shadow-inner">
            {!profile ? (
              <div className="w-full text-center text-xs text-red-500 font-bold p-2 bg-red-50 rounded-xl">Debes ir a Perfil y registrarte para chatear.</div>
            ) : (
              <>
                <input type="text" value={txt} onChange={e=>setTxt(e.target.value)} placeholder="Escribe un mensaje..." className="flex-1 bg-gray-50 rounded-full px-6 text-sm outline-none border border-gray-200 focus:border-[#1877F2] transition-colors shadow-inner" onKeyDown={e=>e.key==='Enter'&&send()} />
                <button onClick={send} className="w-12 h-12 rounded-full bg-[#1877F2] text-white flex items-center justify-center active:scale-90 shadow-lg transition-transform"><i className="fa-solid fa-paper-plane text-xl"></i></button>
              </>
            )}
          </div>
        </div>
      );
    }

    function WisdomPanel() {
      const [messages, setMessages] = useState([]); const [val, setVal] = useState(''); const [loading, setLoading] = useState(false);
      const end = useRef(null);
      const ask = async () => {
        if(!val.trim() || loading) return; const q = val; setVal(''); setMessages(p => [...p, {role:'u', text:q}]); setLoading(true);
        try {
          const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKeyGemini}`, {
            method:'POST', body: JSON.stringify({ contents:[{parts:[{text:q}]}], systemInstruction:{parts:[{text:"Eres el Sabio Davar. Responde brevemente con sabidur√≠a ministerial."}]} })
          });
          const d = await r.json(); setMessages(p => [...p, {role:'ai', text: d.candidates?.[0]?.content?.parts?.[0]?.text || "La Jerarqu√≠a Mayor nos invita a la reflexi√≥n."}]);
        } catch(e) { setMessages(p => [...p, {role:'ai', text:"Conexi√≥n ministerial d√©bil."}]); }
        setLoading(false);
      };
      useEffect(() => { end.current?.scrollIntoView({behavior:'smooth'}); }, [messages]);
      return (
        <div className="h-[75vh] flex flex-col card-fb overflow-hidden border-t-4 border-blue-500 animate-up bg-white shadow-xl mt-4">
          <div className="p-4 text-center font-bold uppercase text-gray-500 text-[11px] bg-white border-b tracking-widest italic">Sabidur√≠a Davar (AI)</div>
          <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-[#f0f2f5] custom-scrollbar">
            {messages.map((m,i)=>(<div key={i} className={`flex ${m.role==='ai'?'justify-start':'justify-end'}`}><div className={`p-4 rounded-2xl text-[14px] max-w-[85%] shadow-sm ${m.role==='ai'?'bg-white border text-gray-800 shadow-md':'bg-[#1877f2] text-white'}`}>{m.text}</div></div>))}
            {loading && <div className="text-blue-500 text-[10px] font-black animate-pulse text-center mt-3 uppercase tracking-widest">Consultando...</div>}
            <div ref={end} />
          </div>
          <div className="p-4 flex gap-3 bg-white border-t"><input type="text" value={val} onChange={e=>setVal(e.target.value)} placeholder="¬øDuda espiritual?" className="flex-1 input-pill bg-[#f0f2f5]" onKeyDown={e=>e.key==='Enter'&&ask()} /><button onClick={ask} className="w-12 h-12 rounded-full bg-blue-600 text-white flex items-center justify-center active:scale-90 shadow-lg"><i className="fa-solid fa-sparkles text-xl"></i></button></div>
        </div>
      );
    }

    function GroupView({ user, profile }) {
      const [groups, setGroups] = useState([]); const [showAdd, setShowAdd] = useState(false);
      const [gName, setGName] = useState(''); const [gDesc, setGDesc] = useState('');
      const colG = db.collection('artifacts').doc(appId).collection('users');
      
      useEffect(() => { 
          if(!user) return;
          const unsub = colG.onSnapshot(s => {
              let all = [];
              s.docs.forEach(d => { if(d.data().groups) all = [...all, ...d.data().groups]; });
              setGroups(all);
          }, (err) => console.log("")); 
          return ()=>unsub(); 
      }, [user]);
      
      const save = async () => { 
          if(!gName || !user) return; 
          const nG = { id: Date.now().toString(), name:gName, desc:gDesc, author:profile?.name||"L√≠der Ministerial", at:Date.now() };
          await colG.doc(user.uid).set({ groups: firebase.firestore.FieldValue.arrayUnion(nG) }, { merge: true }); 
          setShowAdd(false); setGName(''); setGDesc(''); 
      };
      return (
        <div className="space-y-6 pb-24 max-w-[850px] mx-auto animate-in px-4 mt-4">
          <div className="card-social p-6 flex justify-between items-center bg-white border-t-4 border-blue-500 shadow-lg">
            <h2 className="font-black text-2xl text-gray-800 uppercase tracking-tighter italic"><i className="fa-solid fa-users-rectangle mr-3 text-blue-600"></i> Grupos de Pr√©dica</h2>
            <button onClick={()=>setShowAdd(true)} disabled={!profile} className="bg-blue-600 disabled:bg-gray-400 text-white px-8 py-3 rounded-2xl font-black text-xs shadow-lg active:scale-95 transition-all uppercase tracking-widest">+ Crear Grupo</button>
          </div>
          {showAdd && (
            <div className="card-social p-8 animate-in bg-white shadow-2xl border-2 border-blue-50">
              <input type="text" placeholder="Nombre del Grupo" value={gName} onChange={e=>setGName(e.target.value)} className="input-pill bg-gray-50 border mb-4 h-14 shadow-inner text-lg font-bold w-full" />
              <textarea placeholder="Descripci√≥n ministerial..." value={gDesc} onChange={e=>setGDesc(e.target.value)} className="input-pill bg-gray-50 border mb-6 h-32 resize-none shadow-inner text-lg w-full" />
              <div className="flex gap-4"><button onClick={()=>setShowAdd(false)} className="flex-1 bg-gray-100 py-4.5 rounded-2xl font-black text-gray-500 hover:bg-gray-200 uppercase text-[11px] tracking-widest transition-all">Cancelar</button><button onClick={save} className="flex-1 bg-blue-600 text-white py-4.5 rounded-2xl font-black shadow-lg hover:bg-blue-700 uppercase text-[11px] tracking-widest transition-all">Confirmar</button></div>
            </div>
          )}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-7">
            {groups.map(g => (
              <div key={g.id} className="card-social p-7 bg-white border border-gray-200 shadow-sm hover:shadow-2xl transition-all flex flex-col">
                <h3 className="font-black text-2xl text-blue-600 leading-tight mb-3 italic uppercase tracking-tighter">#{g.name}</h3>
                <p className="text-gray-600 mt-2 line-clamp-3 leading-relaxed mb-6 font-medium">{g.desc}</p>
                <div className="mt-auto flex justify-between items-center border-t pt-5"><span className="text-[11px] font-black text-gray-400 uppercase tracking-widest italic leading-none">L√≠der: {g.author}</span><button className="bg-blue-50 text-blue-600 px-6 py-2.5 rounded-2xl font-black text-[11px] uppercase tracking-widest active:scale-95 hover:bg-blue-100 transition-all border border-blue-100 shadow-sm">Unirse Ahora</button></div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function StoreView({ user, profile }) {
      const [items, setItems] = useState([]); const [showAdd, setShowAdd] = useState(false);
      const [pName, setPName] = useState(''); const [pPrice, setPPrice] = useState(''); const [pImg, setPImg] = useState('');
      const colS = db.collection('artifacts').doc(appId).collection('users');
      
      useEffect(() => { 
        if(!user) return;
        const unsub = colS.onSnapshot(s => {
          let all = [];
          s.docs.forEach(d => { if(d.data().store) all = [...all, ...d.data().store]; });
          const sorted = all.sort((a,b) => b.at - a.at);
          setItems(sorted);
        }, (err) => console.log("")); 
        return ()=>unsub(); 
      }, [user]);

      const save = async () => { 
          if(!pName || !pImg || !user) return; 
          const nI = { id: Date.now().toString(), author:profile?.name||"Siervo Davar", name:pName, price:pPrice, img:pImg, at:Date.now() };
          await colS.doc(user.uid).set({ store: firebase.firestore.FieldValue.arrayUnion(nI) }, { merge: true }); 
          setShowAdd(false); setPName(''); setPPrice(''); setPImg(''); 
      };
      
      return (
        <div className="space-y-6 pb-24 max-w-[1050px] mx-auto animate-in px-4 mt-4">
          <div className="card-social p-6 flex justify-between items-center bg-white border-t-4 border-green-500 shadow-lg">
            <h2 className="font-black text-2xl text-gray-800 uppercase tracking-tighter italic"><i className="fa-solid fa-store mr-3 text-green-600"></i> Tienda Ministerial</h2>
            <button onClick={()=>setShowAdd(true)} disabled={!profile} className="bg-green-600 disabled:bg-gray-400 text-white px-8 py-3 rounded-2xl font-black text-xs shadow-lg active:scale-95 transition-all uppercase tracking-widest">+ Vender algo</button>
          </div>
          {showAdd && (
            <div className="card-social p-10 animate-in bg-white shadow-2xl border-2 border-green-50 text-left">
              <input type="text" placeholder="¬øQu√© ofreces a los hermanos?" value={pName} onChange={e=>setPName(e.target.value)} className="input-pill bg-gray-50 border mb-6 h-14 shadow-inner text-lg font-bold w-full" />
              <input type="text" placeholder="Precio (Ej: 10.000)" value={pPrice} onChange={e=>setPPrice(e.target.value)} className="input-pill bg-gray-50 border mb-6 h-14 shadow-inner text-lg font-bold w-full" />
              <label className="bg-blue-50 text-blue-600 px-5 py-6 rounded-2xl cursor-pointer font-black block text-center mb-6 border-2 border-dashed border-blue-200 hover:bg-blue-100 shadow-sm uppercase text-[13px] tracking-widest transition-all">A√±adir foto del producto<input type="file" className="hidden" accept="image/*" onChange={async e=>{setPImg(await optimizeMedia(e.target.files[0]));}} /></label>
              {pImg && <img src={pImg} className="h-56 w-56 object-cover rounded-2xl border-4 border-white mb-7 mx-auto shadow-2xl" />}
              <button onClick={save} className="w-full bg-green-600 text-white font-black py-5 rounded-2xl shadow-xl active:scale-95 transition-all uppercase text-[15px] tracking-widest h-16">Publicar en Tienda</button>
            </div>
          )}
          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
            {items.map(i => (
              <div key={i.id} className="store-item bg-white animate-in rounded-2xl flex flex-col border border-gray-200 shadow-sm hover:shadow-2xl transition-all overflow-hidden relative group">
                <img src={i.img} className="h-44 w-full object-cover rounded-t-2xl" />
                <div className="p-4 flex-1 flex flex-col bg-white">
                  <p className="text-green-700 font-black text-xl mb-1 italic font-serif">${i.price}</p>
                  <h4 className="font-bold text-gray-800 truncate text-[14px] mb-3 uppercase tracking-tighter">{i.name}</h4>
                  <button onClick={()=>window.open(`https://api.whatsapp.com/send?text=Bendiciones hermano ${i.author}, me interesa tu producto en Davar: ${i.name}`,'_blank')} className="w-full mt-auto bg-gray-100 py-3 rounded-xl font-black text-[10px] uppercase hover:bg-gray-200 transition-all border border-gray-100 mt-2 active:scale-90 shadow-sm">WhatsApp</button>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function ProfilePosts({ user, profile }) {
      if (!user || !profile) return null;
      const [myPosts, setMyPosts] = useState([]);
      useEffect(() => {
        const unsub = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).onSnapshot(s => {
          if (s.exists && s.data().posts) {
              const arr = s.data().posts.sort((a,b)=>b.at - a.at);
              setMyPosts(arr);
          }
        }, (err) => console.log(""));
        return () => unsub();
      }, [user.uid]);
      
      const deletePost = async (p) => { 
          if(confirm("¬øDesea eliminar esta bendici√≥n de su historial permanentemente?")) {
              await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).set({
                  posts: firebase.firestore.FieldValue.arrayRemove(p)
              }, { merge: true });
          }
      };

      return (
        <div className="max-w-[620px] mx-auto space-y-4 mt-8 px-2 md:px-0">
          <h3 className="font-black text-sm uppercase tracking-widest text-gray-400 ml-2 mb-4 italic text-center">Mis Publicaciones Ministeriales</h3>
          {myPosts.map(p => (
            <div key={p.id} className="card-social bg-white p-5 shadow-lg border border-gray-100 flex justify-between items-start animate-up">
               <div className="flex-1 text-left pr-4">
                  <p className="text-[10px] text-[#1877F2] font-black uppercase tracking-tighter mb-2 italic">Publicado el {new Date(p.at).toLocaleString()}</p>
                  {p.text && <p className="text-[15px] line-clamp-3 italic text-gray-700">"{p.text}"</p>}
                  {p.video && <p className="text-[11px] text-blue-500 font-bold mt-2"><i className="fa-solid fa-video"></i> Incluye Video/Transmisi√≥n</p>}
                  {p.img && <p className="text-[11px] text-green-600 font-bold mt-2"><i className="fa-solid fa-image"></i> Incluye Fotograf√≠a</p>}
                  {p.audio && <p className="text-[11px] text-orange-500 font-bold mt-2"><i className="fa-solid fa-microphone"></i> Incluye Testimonio de Voz</p>}
               </div>
               <button onClick={()=>deletePost(p)} className="w-12 h-12 rounded-full bg-red-50 text-red-500 hover:bg-red-100 flex items-center justify-center transition-all shadow-sm flex-shrink-0" title="Eliminar Publicaci√≥n"><i className="fa-solid fa-trash-can text-lg"></i></button>
            </div>
          ))}
          {myPosts.length === 0 && <p className="text-center p-8 text-gray-400 font-black uppercase text-xs italic tracking-widest">A√∫n no has sembrado bendiciones.</p>}
        </div>
      );
    }

    // --- APP PRINCIPAL Y ESCUDO DE SEGURIDAD LIBERADO ---
    function App() {
      const [user, setUser] = useState(null); 
      const [profile, setProfile] = useState(null);
      const [tab, setTab] = useState('feed'); 
      const [isUnlocked, setUnlocked] = useState(sessionStorage.getItem('davar_unlocked') === 'true');
      const [pinIn, setPinIn] = useState(''); 
      const [isBroadcasting, setIsBroadcasting] = useState(false); 
      const [liveId, setLiveId] = useState(null);
      const [editM, setEditM] = useState(false); 
      const [isAdmin, setIsAdmin] = useState(sessionStorage.getItem('davar_admin') === 'true');
      
      const [regName, setRegName] = useState(''); 
      const [regPin, setRegPin] = useState('');
      const [localEditName, setLocalEditName] = useState('');
      const [localEditPin, setLocalEditPin] = useState('');
      
      const [loadingAuth, setLoadingAuth] = useState(true); 

      useEffect(() => {
        let unsubProfile = null;
        
        // Entrada Libre como An√≥nimo Inmediata
        const ensureAuth = async () => {
          try {
             await auth.signInAnonymously();
          } catch(e) {
             setLoadingAuth(false);
          }
        };
        ensureAuth();

        const unsubAuth = auth.onAuthStateChanged((cur) => {
          if (cur) {
             setUser(cur);
             // BUSCAMOS EL PERFIL EN LA RUTA PERMITIDA DEL USUARIO
             unsubProfile = db.collection('artifacts').doc(appId).collection('users').doc(cur.uid).onSnapshot(pDoc => {
                if(pDoc.exists && pDoc.data().profile) {
                   const d = pDoc.data().profile;
                   setProfile(d);
                   setLocalEditName(d.name);
                   setLocalEditPin(d.pin);
                } else {
                   setProfile(null);
                }
                setLoadingAuth(false);
             }, err => {
                setLoadingAuth(false);
             });
          } else {
             setLoadingAuth(false);
          }
        });

        return () => {
          unsubAuth();
          if (unsubProfile) unsubProfile();
        };
      }, []);

      const resetHome = () => { setTab('feed'); setLiveId(null); setIsBroadcasting(false); setEditM(false); document.getElementById('main-scroller')?.scrollTo({top:0, behavior:'smooth'}); };

      const updateMedia = (field) => {
        const input = document.createElement('input'); input.type='file'; input.accept='image/*';
        input.onchange = async (e) => { 
          const r = await optimizeMedia(e.target.files[0]); 
          const updatedProfile = { ...profile, [field]: r };
          await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).set({ profile: updatedProfile }, { merge: true }); 
        };
        input.click();
      };

      const handleRegister = async (e) => {
        e.preventDefault();
        if (!regName.trim() || !regPin.trim() || !user) return;
        try {
          const pr = { uid: user.uid, name: regName.trim(), pin: regPin.trim(), photo: LOGO_URL, cover: DEFAULT_COVER, at: Date.now() };
          await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).set({ profile: pr }, { merge: true });
          setUnlocked(true);
          sessionStorage.setItem('davar_unlocked', 'true');
        } catch (err) {
          alert("Error de conexi√≥n divina.");
        }
      };

      const handleAdminAccess = () => {
         if (!isAdmin) {
             const pwd = prompt("Jerarqu√≠a Mayor - Ingrese la Llave Global:");
             if (pwd === "davar2026" || pwd === "guia2026") {
                 setIsAdmin(true);
                 sessionStorage.setItem('davar_admin', 'true');
                 alert("Autoridad Ministerial Concedida. Ahora puede borrar cualquier elemento.");
             } else if (pwd !== null) {
                 alert("Llave incorrecta.");
             }
         } else {
             alert("Ya posee la Autoridad Ministerial.");
         }
      };

      // --- PROTECCI√ìN DE SESI√ìN (SOLO SI YA TIENE PERFIL Y NO HA PUESTO SU PIN) ---
      if (loadingAuth) return <div className="h-screen bg-[#F0F2F5] flex flex-col items-center justify-center animate-in"><div className="logo-cd mb-6 shadow-2xl scale-125"><span className="initials">CD</span><span className="sub-text">Dios</span></div><p className="text-[#1877F2] font-black uppercase tracking-widest italic animate-pulse">Abriendo Puertas...</p></div>;
      
      // Si ya est√° registrado, le pedimos su PIN para dejarlo entrar.
      if (profile && !isUnlocked) return ( <div className="h-screen flex items-center justify-center p-6 bg-[#F0F2F5]"><div className="card-social p-12 w-full max-w-md text-center border-t-4 border-blue-600 animate-fast shadow-2xl bg-white"><img src={profile.photo || LOGO_URL} className="w-36 h-36 mx-auto mb-8 rounded-full border-4 border-[#1877F2] object-cover shadow-2xl" /><h2 className="font-black text-gray-800 uppercase tracking-widest italic leading-none mb-3 text-2xl text-center">{profile.name}</h2><p className="text-gray-500 text-[12px] font-black uppercase mb-12 italic tracking-widest opacity-60 text-center">Proteja su sesi√≥n con su PIN</p><form onSubmit={(e)=>{e.preventDefault(); if(pinIn===profile.pin) { setUnlocked(true); sessionStorage.setItem('davar_unlocked','true'); } else alert("PIN Incorrecto");}} className="space-y-7"><input type="password" placeholder="PIN Secreto" className="input-pill bg-white border text-center text-4xl font-black tracking-[0.6em] outline-none shadow-inner h-20 w-full" value={pinIn} onChange={e=>setPinIn(e.target.value)} required autoFocus /><button type="submit" className="w-full bg-[#1877F2] text-white font-black py-5 rounded-2xl shadow-xl active:scale-95 transition-all uppercase tracking-widest h-16 text-[15px]">Abrir Sesi√≥n</button></form></div></div> );

      // --- APOSENTO PRINCIPAL (ACCESO LIBRE DE ENTRADA, REGISTRO EN PERFIL) ---
      return (
        <div className="h-screen flex flex-col overflow-hidden bg-[#F0F2F5]">
          {!profile && <GuestBanner user={user} />}
          <header className="header-fb">
            <div onClick={resetHome} className="flex items-center gap-3 cursor-pointer hover:scale-105 transition-transform flex-shrink-0">
               <div onClick={(e) => { e.stopPropagation(); handleAdminAccess(); }} className="logo-cd" title="Acceso Oculto Administrador"><span className="initials">CD</span><span className="sub-text">Dios</span></div>
               <span className="hidden sm:block font-black text-[#1877F2] uppercase tracking-tighter italic text-lg ml-2">Comunidad Davar {isAdmin && <span className="text-red-500 text-[10px] ml-1">(Admin)</span>}</span>
            </div>
            <div className="nav-container">
              <div onClick={resetHome} className={`nav-icon ${tab==='feed'?'active':''}`} title="Inicio"><i className="fa-solid fa-house"></i></div>
              <div onClick={()=>setTab('chat')} className={`nav-icon ${tab==='chat'?'active':''}`} title="Chat"><i className="fa-solid fa-message"></i></div>
              <div onClick={()=>setTab('wisdom')} className={`nav-icon ${tab==='wisdom'?'active':''}`} title="Sabidur√≠a"><i className="fa-solid fa-sparkles"></i></div>
              <div onClick={()=>setTab('groups')} className={`nav-icon ${tab==='groups'?'active':''}`} title="Grupos"><i className="fa-solid fa-users-rectangle"></i></div>
              <div onClick={()=>setTab('store')} className={`nav-icon ${tab==='store'?'active':''}`} title="Tienda"><i className="fa-solid fa-store"></i></div>
              <div onClick={()=>setTab('profile')} className={`nav-icon ${tab==='profile'?'active':''}`} title="Perfil"><i className="fa-solid fa-circle-user"></i></div>
            </div>
            <div className="flex items-center gap-3">
              <div onClick={()=>{sessionStorage.clear(); window.location.reload();}} className="btn-circle-action text-red-600 bg-red-50 hover:bg-red-100 border-none w-10 h-10 transition-all active:scale-90 shadow-sm" title="Salir"><i className="fa-solid fa-power-off text-lg"></i></div>
            </div>
          </header>

          <main id="main-scroller" className="flex-1 overflow-y-auto custom-scrollbar pt-[75px] pb-12 px-2 md:px-6 scroll-smooth">
             <div className={`w-full ${(tab==='chat' || tab==='wisdom' || tab==='store' || tab==='groups') ? 'max-w-[1200px]' : 'max-w-[650px]'} mx-auto transition-all`}>
                {tab==='feed' && <WallView user={user} profile={profile} isAdmin={isAdmin} onStartLive={()=>setIsBroadcasting(true)} onJoinLive={id=>setLiveId(id)} />}
                {tab==='chat' && <div className="h-[84vh] animate-up shadow-xl rounded-xl overflow-hidden border border-gray-200 bg-white mt-4"><ChatPanel user={user} profile={profile} isAdmin={isAdmin} /></div>}
                {tab==='wisdom' && <WisdomPanel />}
                {tab==='groups' && <GroupView user={user} profile={profile} />}
                {tab==='store' && <StoreView user={user} profile={profile} isAdmin={isAdmin} />}
                {tab==='profile' && (
                  !profile ? (
                    <div className="card-social p-10 max-w-md mx-auto mt-10 text-center shadow-2xl animate-in bg-white border-t-4 border-blue-600">
                      <div className="logo-cd mx-auto mb-6 scale-125"><span className="initials">CD</span><span className="sub-text">Dios</span></div>
                      <h3 className="mb-4 font-black text-gray-800 uppercase tracking-widest leading-tight text-xl text-center">√önete a la Familia</h3>
                      <p className="text-gray-500 text-xs mb-8">Debes crear tu perfil para poder publicar y comentar en la red.</p>
                      <form onSubmit={handleRegister} className="space-y-6 text-left">
                        <div><label className="text-[12px] font-black uppercase text-gray-400 ml-2 tracking-widest">Nombre Completo</label><input type="text" value={regName} onChange={e=>setRegName(e.target.value)} className="input-pill bg-gray-50 border shadow-inner mt-2 h-14 text-lg font-bold w-full outline-none" required /></div>
                        <div><label className="text-[12px] font-black uppercase text-gray-400 ml-2 tracking-widest">Crear PIN (N√∫meros)</label><input type="password" value={regPin} onChange={e=>setRegPin(e.target.value)} className="input-pill bg-gray-50 border text-center text-xl font-black tracking-[0.5em] shadow-inner mt-2 h-14 w-full outline-none" required /></div>
                        <button type="submit" className="w-full bg-[#1877F2] text-white font-black py-5 rounded-2xl shadow-xl active:scale-95 uppercase text-[13px] tracking-widest transition-all">Crear Perfil Ministerial</button>
                      </form>
                    </div>
                  ) : (
                    <div className="space-y-6 mt-4">
                      <div className="card-social overflow-hidden animate-in shadow-2xl max-w-[950px] mx-auto pb-10 border-t-4 border-blue-600 bg-white">
                        <div className="relative h-60 bg-gray-200 shadow-inner">
                          <img src={profile?.cover || DEFAULT_COVER} className="profile-banner h-full w-full object-cover" />
                          <button onClick={()=>updateMedia('cover')} className="absolute bottom-4 right-4 bg-white/70 backdrop-blur-md p-3 rounded-xl text-gray-800 shadow cursor-pointer border border-white/40 hover:bg-white transition-all shadow-md active:scale-95"><i className="fa-solid fa-camera mr-2"></i><span className="text-[12px] font-black uppercase tracking-widest">Portada</span></button>
                        </div>
                        <div className="p-10 pt-0 text-center flex flex-col items-center">
                          <div className="avatar-view shadow-xl">
                            <img src={profile?.photo || LOGO_URL} className="w-44 h-44 rounded-full object-cover shadow-2xl border-4 border-white" />
                            <button onClick={()=>updateMedia('photo')} className="absolute bottom-2 right-2 bg-[#1877F2] p-4 rounded-full text-white shadow-xl hover:scale-110 transition-transform"><i className="fa-solid fa-camera text-lg"></i></button>
                          </div>
                          {!editM ? (
                            <>
                              <h2 className="font-black text-4xl mt-6 text-gray-900 tracking-tight uppercase italic leading-none">{profile?.name}</h2>
                              <p className="text-[14px] text-gray-500 mt-2 font-black tracking-widest uppercase italic">Siervo Davar</p>
                              <div className="flex gap-4 mt-8 w-full max-w-[450px]">
                                <button onClick={()=>{setLocalEditName(profile.name); setLocalEditPin(profile.pin); setEditM(true);}} className="flex-1 bg-gray-200 text-gray-800 font-black py-4 rounded-xl shadow-sm uppercase text-[11px] tracking-widest hover:bg-gray-300 transition-all">Editar Perfil</button>
                                <button onClick={()=>{setTab('feed'); setTimeout(()=>document.getElementById('post-dialog')?.classList.remove('hidden'), 100);}} className="flex-1 bg-[#1877f2] text-white font-black py-4 rounded-xl shadow-lg uppercase text-[11px] tracking-widest active:scale-95 transition-all">Crear Publicaci√≥n</button>
                              </div>
                            </>
                          ) : (
                            <div className="mt-8 space-y-6 text-left w-full max-w-[450px] animate-in">
                              <div><label className="text-[12px] font-black uppercase text-gray-400 ml-2 tracking-widest">Nombre Ministerial</label><input type="text" value={localEditName} onChange={e=>setLocalEditName(e.target.value)} className="input-pill bg-white border border-gray-300 h-14 mt-2 shadow-sm font-bold w-full" /></div>
                              <div><label className="text-[12px] font-black uppercase text-gray-400 ml-2 tracking-widest">Nuevo PIN Secreto</label><input type="password" value={localEditPin} onChange={e=>setLocalEditPin(e.target.value)} className="input-pill bg-white border border-gray-300 h-14 mt-2 text-center font-black tracking-[0.5em] shadow-sm w-full" /></div>
                              <div className="flex gap-4 pt-6"><button onClick={()=>setEditM(false)} className="flex-1 bg-gray-100 py-4 rounded-xl font-black text-gray-600 uppercase text-[12px] tracking-widest shadow-sm active:scale-95 transition-all">Cancelar</button><button onClick={async()=>{ const updatedProfile = { ...profile, name:localEditName, pin:localEditPin }; await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).update({profile: updatedProfile}); setEditM(false);}} className="flex-1 bg-[#1877f2] text-white py-4 rounded-xl font-black shadow-xl active:scale-95 transition-all uppercase text-[12px] tracking-widest">Guardar</button></div>
                            </div>
                          )}
                        </div>
                      </div>
                      <ProfilePosts user={user} profile={profile} />
                    </div>
                  )
                )}
             </div>
          </main>
          
          {isBroadcasting && <LiveOverlay profile={profile} bId={user.uid} isB={true} onClose={()=>setIsBroadcasting(false)} onPub={async(vData)=>{ 
              // GUARDA EL VIDEO DEL EN VIVO DIRECTAMENTE EN LOS POSTS
              const newPost = { id: Date.now().toString(), uid:user.uid, author:profile.name, photo:profile.photo, text:"Grabaci√≥n de Transmisi√≥n", video:vData, at:Date.now(), reactions:{}, comments:[] };
              await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).set({ posts: firebase.firestore.FieldValue.arrayUnion(newPost) }, { merge: true });
              setTab('feed'); setIsBroadcasting(false); 
          }} />}
          {liveId && <LiveOverlay profile={profile} bId={liveId} isB={false} onClose={()=>setLiveId(null)} />}
        </div>
      );
    }

    const domContainer = document.getElementById('root');
    const rootReact = ReactDOM.createRoot(domContainer);
    rootReact.render(<App />);
  </script>
</body>
</html>
